<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Let's Play Together</title>
    <link rel="manifest" href="/manifest.json" />
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              secondary: "#8ECAE6",
              accent: "#219EBC",
              dark: "#023047",
              warning: "#FFB703",
              primary: "#FB8500",
            },
          },
        },
      };
    </script>
    <style>
      html,
      body {
        overflow: hidden;
      }
    </style>
  </head>
  <body
    class="min-h-screen flex items-center justify-center bg-gradient-to-br from-gray-900 to-gray-800 p-4"
  >
    <div
      class="w-full max-w-md border-2 border-purple-500 bg-gray-900 text-white rounded-lg shadow-xl -mt-20"
    >
      <!-- Card Header -->
      <div class="p-6 space-y-1 text-center">
        <div class="flex justify-center mb-2">
          <!-- Gamepad SVG Icon -->
          <?xml version="1.0" encoding="iso-8859-1"?>
          <!-- Generator: Adobe Illustrator 19.0.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="64"
            height="64"
            viewBox="0 0 24 24"
            fill="none"
            stroke="#023047"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="lucide lucide-gamepad-2"
          >
            <line x1="6" y1="11" x2="10" y2="11"></line>
            <line x1="8" y1="9" x2="8" y2="13"></line>
            <line x1="15" y1="12" x2="15.01" y2="12"></line>
            <line x1="18" y1="10" x2="18.01" y2="10"></line>
            <path
              d="M17.32 5H6.68a4 4 0 0 0-3.978 3.59c-.006.052-.01.101-.017.152C2.604 9.416 2 14.456 2 16a3 3 0 0 0 3 3c1 0 1.5-.5 2-1l1.414-1.414A2 2 0 0 1 9.828 16h4.344a2 2 0 0 1 1.414.586L17 18c.5.5 1 1 2 1a3 3 0 0 0 3-3c0-1.544-.604-6.584-.685-7.258-.007-.05-.011-.1-.017-.152A4 4 0 0 0 17.32 5z"
            ></path>
          </svg>
        </div>
        <h2 class="text-2xl font-bold text-purple-400">Let's Play Together</h2>
        <p class="text-gray-400">Enter your nickname to connect and play.</p>
      </div>

      <!-- Card Content -->
      <div class="px-6 pb-4">
        <form id="loginForm">
          <div class="space-y-4">
            <div class="space-y-2">
              <input
                id="nickname"
                type="text"
                placeholder="Enter your nickname"
                class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 text-white"
                required
              />
            </div>
            <button
              type="submit"
              id="connectBtn"
              class="w-full py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-md transition-colors"
              disabled
            >
              Connect
            </button>
          </div>
        </form>
      </div>

      <!-- Card Footer -->
      <div
        class="flex flex-col items-center border-t border-gray-800 pt-4 pb-6 px-6"
      >
        <div class="flex space-x-2 items-center">
          <!-- Small Gamepad SVG Icon -->
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="#023047"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="lucide lucide-gamepad-2"
          >
            <line x1="6" y1="11" x2="10" y2="11"></line>
            <line x1="8" y1="9" x2="8" y2="13"></line>
            <line x1="15" y1="12" x2="15.01" y2="12"></line>
            <line x1="18" y1="10" x2="18.01" y2="10"></line>
            <path
              d="M17.32 5H6.68a4 4 0 0 0-3.978 3.59c-.006.052-.01.101-.017.152C2.604 9.416 2 14.456 2 16a3 3 0 0 0 3 3c1 0 1.5-.5 2-1l1.414-1.414A2 2 0 0 1 9.828 16h4.344a2 2 0 0 1 1.414.586L17 18c.5.5 1 1 2 1a3 3 0 0 0 3-3c0-1.544-.604-6.584-.685-7.258-.007-.05-.011-.1-.017-.152A4 4 0 0 0 17.32 5z"
            ></path>
          </svg>
          <span class="text-sm text-gray-400">
            Local co-op gaming has never been easier
          </span>
        </div>
        <p
          class="mt-6 px-3 py-1 text-xs text-gray-200 bg-purple-700 rounded-md italic"
        >
          For the best gaming experience, connect a compatible joystick (Xbox,
          PlayStation, etc.).
        </p>
      </div>
    </div>

    <!-- Modal de espera -->
    <div
      id="waitingModal"
      class="fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-75 hidden"
    >
      <div
        class="bg-gray-900 border-2 border-purple-500 rounded-lg shadow-xl p-8 text-center"
      >
        <h2 class="text-2xl font-bold text-purple-400 mb-4">
          Waiting for confirmation
        </h2>
        <p class="text-gray-400">
          Please wait while the host approves your connection...
        </p>
      </div>
    </div>

    <!-- Modal de mensaje (reemplaza alert) -->
    <div
      id="messageModal"
      class="fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-75 hidden"
    >
      <div
        class="bg-gray-900 border-2 border-purple-500 rounded-lg shadow-xl p-8 text-center"
      >
        <h2
          id="messageTitle"
          class="text-2xl font-bold text-purple-400 mb-4"
        ></h2>
        <p id="messageContent" class="text-gray-400 mb-4"></p>
        <button
          id="messageCloseBtn"
          class="w-full bg-orange-500 hover:bg-orange-600 text-white rounded-md py-2 transition-colors"
        >
          OK
        </button>
      </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const nicknameInput = document.getElementById("nickname");
      const connectBtn = document.getElementById("connectBtn");
      const loginForm = document.getElementById("loginForm");

      nicknameInput.addEventListener("input", function () {
        connectBtn.disabled = !this.value.trim();
      });

      loginForm.addEventListener("submit", function (e) {
        e.preventDefault();
        const nick = nicknameInput.value.trim();
        if (!nick) {
          showMessage("Error", "Please enter a nickname.");
          return;
        }
        waitingModal.classList.remove("hidden");
        socket.emit("peerRequest", { nick });
      });

      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker
            .register("/sw.js")
            .then((registration) => {
              console.log(
                "Service Worker registrado con scope:",
                registration.scope
              );
            })
            .catch((error) => {
              console.error("Error al registrar el Service Worker:", error);
            });
        });
      }

      window.addEventListener("load", () => {
        document.cookie =
          "approved=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/";
      });

      const socket = io();
      const waitingModal = document.getElementById("waitingModal");
      const messageModal = document.getElementById("messageModal");
      const messageTitle = document.getElementById("messageTitle");
      const messageContent = document.getElementById("messageContent");
      const messageCloseBtn = document.getElementById("messageCloseBtn");

      function showMessage(title, message) {
        messageTitle.textContent = title;
        messageContent.textContent = message;
        messageModal.classList.remove("hidden");
      }

      messageCloseBtn.addEventListener("click", () => {
        messageModal.classList.add("hidden");
      });

      socket.on("peerApproval", (data) => {
        waitingModal.classList.add("hidden");
        if (data.approved) {
          localStorage.setItem("userNick", nicknameInput.value.trim());
          // Se establece la cookie aprobada y se redirige a watch.html
          document.cookie = "approved=1; path=/";
          window.location.href = "/watch.html";
        } else {
          showMessage("Rejected", "Request denied by the host.");
        }
      });
    </script>
  </body>
</html>
