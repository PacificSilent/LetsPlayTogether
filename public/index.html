<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Lets Play Together</title>
    <link rel="manifest" href="/manifest.json" />
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              secondary: "#8ECAE6",
              accent: "#219EBC",
              dark: "#023047",
              warning: "#FFB703",
              primary: "#FB8500",
            },
          },
        },
      };
    </script>
  </head>
  <body class="bg-dark text-secondary">
    <div class="flex flex-col items-center min-h-screen pt-16">
      <!-- Título fuera del card -->
      <h1 class="text-4xl font-bold text-primary mb-8">Lets Play Together</h1>
      <!-- Card para el ingreso de nick -->
      <div class="bg-white shadow-xl rounded-lg p-8 w-full max-w-md mx-auto">
        <p class="mb-4 text-secondary">Ingresa tu nick para jugar:</p>
        <input
          type="text"
          id="nickname"
          placeholder="Ingresa tu nombre o nick"
          class="w-full border border-gray-300 rounded-md p-2 mb-4 focus:outline-none focus:ring-2 focus:ring-primary"
        />
        <button
          id="connectBtn"
          class="w-full bg-primary text-white rounded-md py-2 hover:bg-accent mb-4"
        >
          Conectar
        </button>
        <!-- Botón de instalación de PWA, oculto inicialmente -->
        <button
          id="installBtn"
          class="w-full bg-accent text-white rounded-md py-2 hover:bg-blue-700 hidden"
        >
          Instalar App
        </button>
      </div>
    </div>

    <!-- Modal de espera -->
    <div
      id="waitingModal"
      class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden"
    >
      <div class="bg-white rounded-lg p-8 text-center">
        <h2 class="text-2xl font-bold text-primary mb-4">
          Esperando confirmación
        </h2>
        <p class="text-secondary">
          Por favor, espera mientras el host aprueba tu conexión...
        </p>
      </div>
    </div>

    <!-- Modal de mensaje (reemplaza alert) -->
    <div
      id="messageModal"
      class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden"
    >
      <div class="bg-white rounded-lg p-8 text-center">
        <h2 id="messageTitle" class="text-2xl font-bold text-primary mb-4"></h2>
        <p id="messageContent" class="text-secondary mb-4"></p>
        <button
          id="messageCloseBtn"
          class="w-full bg-primary text-white rounded-md py-2 hover:bg-accent"
        >
          OK
        </button>
      </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      // Registra el service worker
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker
            .register("/sw.js")
            .then((registration) => {
              console.log(
                "Service Worker registrado con scope:",
                registration.scope
              );
            })
            .catch((error) => {
              console.error("Error al registrar el Service Worker:", error);
            });
        });
      }

      // Limpiar la cookie de aprobación al cargar la página
      window.addEventListener("load", () => {
        document.cookie =
          "approved=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/";
      });

      const socket = io();
      const waitingModal = document.getElementById("waitingModal");
      const messageModal = document.getElementById("messageModal");
      const messageTitle = document.getElementById("messageTitle");
      const messageContent = document.getElementById("messageContent");
      const messageCloseBtn = document.getElementById("messageCloseBtn");

      // Función para mostrar un mensaje en un modal
      function showMessage(title, message) {
        messageTitle.textContent = title;
        messageContent.textContent = message;
        messageModal.classList.remove("hidden");
      }

      // Cerrar modal de mensaje al presionar OK
      messageCloseBtn.addEventListener("click", () => {
        messageModal.classList.add("hidden");
      });

      // Evento para el botón Conectar
      document.getElementById("connectBtn").addEventListener("click", () => {
        const nick = document.getElementById("nickname").value.trim();
        if (!nick) {
          showMessage("Error", "Por favor, ingresa un nombre.");
          return;
        }
        // Mostrar el modal de espera
        waitingModal.classList.remove("hidden");
        socket.emit("peerRequest", { nick });

        socket.on("peerApproval", (data) => {
          // Ocultar el modal de espera
          waitingModal.classList.add("hidden");
          if (data.approved) {
            // Se establece la cookie aprobada y se redirige a watch.html
            document.cookie = "approved=1; path=/";
            window.location.href = "/watch.html";
          } else {
            showMessage("Rechazado", "Solicitud rechazada por el broadcaster.");
          }
        });
      });

      // Manejo del evento beforeinstallprompt para mostrar el botón de instalar
      let deferredPrompt;
      window.addEventListener("beforeinstallprompt", (e) => {
        // Previene que el navegador muestre el prompt automáticamente
        e.preventDefault();
        deferredPrompt = e;
        // Mostrar el botón de instalación
        document.getElementById("installBtn").classList.remove("hidden");
      });

      // Evento para el botón de instalación
      document
        .getElementById("installBtn")
        .addEventListener("click", async () => {
          if (deferredPrompt) {
            deferredPrompt.prompt(); // Muestra el prompt de instalación
            const { outcome } = await deferredPrompt.userChoice;
            console.log(`User response to the install prompt: ${outcome}`);
            // Ocultar el botón de instalación después de la respuesta
            document.getElementById("installBtn").classList.add("hidden");
            deferredPrompt = null;
          }
        });
    </script>
    <script>
      function isIOS() {
        return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
      }

      if (isIOS()) {
        // Muestra un modal o mensaje con instrucciones para iOS
        showMessage(
          "Instalar App",
          "Para instalar la app, toca el botón de compartir y selecciona 'Añadir a la pantalla de inicio'."
        );
      }
    </script>
  </body>
</html>
